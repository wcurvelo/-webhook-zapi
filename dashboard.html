<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WDespachante - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15); }
    .fade-in { animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-bubble { position: relative; }
    .message-bubble::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; border-radius: 4px; }
    .message-ia::after { background: linear-gradient(to bottom, #8b5cf6, #a78bfa); }
    .message-user::after { background: linear-gradient(to bottom, #3b82f6, #60a5fa); }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white py-6 px-8 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold flex items-center gap-3">
          <span class="text-4xl">ğŸš—</span>
          WDespachante
        </h1>
        <p class="text-slate-400 mt-1">Av. Treze de Maio, 23 - Centro, RJ â€¢ 18 anos de experiÃªncia</p>
      </div>
      <div class="flex gap-3">
        <span class="bg-green-500/20 text-green-400 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2">
          <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
          Google Drive Ativo
        </span>
        <span class="bg-purple-500/20 text-purple-400 px-4 py-2 rounded-full text-sm font-medium">
          DeepSeek V3.2
        </span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-8">
    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-2xl p-6 shadow-sm card-hover transition-all cursor-pointer">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-500 text-sm font-medium">Mensagens</p>
            <p class="text-3xl font-bold text-slate-800 mt-1" id="stat-messages">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">ğŸ’¬</div>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl p-6 shadow-sm card-hover transition-all cursor-pointer">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-500 text-sm font-medium">Documentos</p>
            <p class="text-3xl font-bold text-slate-800 mt-1" id="stat-docs">0</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“</div>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl p-6 shadow-sm card-hover transition-all cursor-pointer">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-500 text-sm font-medium">OrÃ§amentos</p>
            <p class="text-3xl font-bold text-slate-800 mt-1" id="stat-budgets">0</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">ğŸ’°</div>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl p-6 shadow-sm card-hover transition-all cursor-pointer">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-500 text-sm font-medium">Faturamento</p>
            <p class="text-3xl font-bold text-emerald-600 mt-1" id="stat-revenue">R$ 0</p>
          </div>
          <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“ˆ</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
      <!-- PreÃ§os -->
      <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm">
        <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
          <span>ğŸ’µ</span> Tabela de PreÃ§os
        </h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="text-left text-slate-500 text-sm border-b border-slate-100">
                <th class="pb-4 font-medium">ServiÃ§o</th>
                <th class="pb-4 font-medium text-right">HonorÃ¡rio</th>
                <th class="pb-4 font-medium text-right">Taxa DETRAN</th>
                <th class="pb-4 font-medium text-right">Total</th>
              </tr>
            </thead>
            <tbody id="prices-table" class="text-slate-700"></tbody>
          </table>
        </div>
      </div>

      <!-- AÃ§Ãµes RÃ¡pidas -->
      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
          <span>âš¡</span> AÃ§Ãµes RÃ¡pidas
        </h2>
        <div class="space-y-3">
          <button onclick="testMessage()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 py-3 px-4 rounded-xl font-medium flex items-center gap-3 transition-colors">
            <span>ğŸ’¬</span> Testar Mensagem
          </button>
          <button onclick="testBudget()" class="w-full bg-green-50 hover:bg-green-100 text-green-700 py-3 px-4 rounded-xl font-medium flex items-center gap-3 transition-colors">
            <span>ğŸ’°</span> Gerar OrÃ§amento
          </button>
          <button onclick="loadAll()" class="w-full bg-slate-50 hover:bg-slate-100 text-slate-700 py-3 px-4 rounded-xl font-medium flex items-center gap-3 transition-colors">
            <span>ğŸ”„</span> Atualizar Tudo
          </button>
        </div>
        
        <div class="mt-8 p-4 bg-amber-50 rounded-xl border border-amber-200">
          <h3 class="font-semibold text-amber-800 mb-2 flex items-center gap-2">
            <span>ğŸ’¡</span> Dica
          </h3>
          <p class="text-amber-700 text-sm">Os documentos enviados pelo WhatsApp aparecerÃ£o automaticamente aqui!</p>
        </div>
      </div>
    </div>

    <!-- Mensagens e Atendimento IA -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Mensagens -->
      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <span>ğŸ’¬</span> Mensagens Recentes
          </h2>
          <span class="text-slate-400 text-sm" id="msgs-count">0 mensagens</span>
        </div>
        <div id="messages-list" class="space-y-4 max-h-96 overflow-y-auto">
          <!-- Mensagens serÃ£o inseridas aqui -->
        </div>
        <div id="no-messages" class="text-center py-12 text-slate-400">
          <div class="text-6xl mb-4">ğŸ’¬</div>
          <p class="text-lg">Nenhuma mensagem ainda</p>
        </div>
      </div>

      <!-- Respostas IA -->
      <div class="bg-white rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <span>ğŸ¤–</span> Respostas da IA
          </h2>
          <span class="text-purple-500 text-sm" id="ai-count">0 respostas</span>
        </div>
        <div id="ai-responses" class="space-y-4 max-h-96 overflow-y-auto">
          <!-- Respostas da IA serÃ£o inseridas aqui -->
        </div>
        <div id="no-ai" class="text-center py-12 text-slate-400">
          <div class="text-6xl mb-4">ğŸ¤–</div>
          <p class="text-lg">Nenhuma resposta da IA ainda</p>
          <p class="text-sm mt-1">As respostas do DeepSeek aparecerÃ£o aqui</p>
        </div>
      </div>
    </div>

    <!-- Documentos -->
    <div class="bg-white rounded-2xl p-6 shadow-sm">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
          <span>ğŸ“</span> Documentos no Google Drive
        </h2>
        <span class="text-slate-400 text-sm" id="docs-count">0 documentos</span>
      </div>
      <div id="documents-list" class="grid gap-4">
        <!-- Documentos serÃ£o inseridos aqui -->
      </div>
      <div id="no-docs" class="text-center py-12 text-slate-400">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <p class="text-lg">Nenhum documento ainda</p>
      </div>
    </div>
  </main>

  <script>
    const TAXA_DETRAN = 209.78;
    const SERVICOS = [
      { nome: 'TransferÃªncia', preco: 450 },
      { nome: 'Licenciamento Simples', preco: 150 },
      { nome: 'Licenciamento c/ DÃ©bitos', preco: 250 },
      { nome: 'Baixa de Gravame', preco: 450 },
      { nome: 'ComunicaÃ§Ã£o de Venda', preco: 350 },
      { nome: '2Âª Via CRV', preco: 450 },
      { nome: 'ATPV Digital', preco: 250 }
    ];

    function renderPrices() {
      const tbody = document.getElementById('prices-table');
      tbody.innerHTML = SERVICOS.map(s => `
        <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
          <td class="py-4 font-medium">${s.nome}</td>
          <td class="py-4 text-right">R$ ${s.preco.toFixed(2)}</td>
          <td class="py-4 text-right">R$ ${TAXA_DETRAN.toFixed(2)}</td>
          <td class="py-4 text-right font-bold text-emerald-600">R$ ${(s.preco + TAXA_DETRAN).toFixed(2)}</td>
        </tr>
      `).join('');
    }

    function renderMessages(msgs) {
      const container = document.getElementById('messages-list');
      const noMsgs = document.getElementById('no-messages');
      document.getElementById('msgs-count').textContent = `${msgs.length} mensagem${msgs.length !== 1 ? 'ns' : ''}`;
      
      if (msgs.length === 0) {
        container.innerHTML = '';
        noMsgs.style.display = 'block';
        return;
      }
      
      noMsgs.style.display = 'none';
      container.innerHTML = msgs.map(m => {
        const date = new Date(m.created_at).toLocaleString('pt-BR');
        const response = m.deepseek_response ? 'âœ…' : 'â³';
        
        return `
          <div class="message-bubble message-user bg-slate-50 p-4 rounded-xl">
            <div class="flex justify-between items-start mb-2">
              <span class="font-semibold text-slate-700">${m.phone}</span>
              <span class="text-xs text-slate-400">${date}</span>
            </div>
            <p class="text-slate-600 text-sm">${m.text || 'â€”'}</p>
            <div class="flex justify-between items-center mt-2">
              <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${m.category || 'sem categoria'}</span>
              <span class="text-xs ${m.deepseek_response ? 'text-green-600' : 'text-amber-600'}">${response} IA</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAIResponses(msgs) {
      const container = document.getElementById('ai-responses');
      const noAI = document.getElementById('no-ai');
      const withAI = msgs.filter(m => m.deepseek_response);
      document.getElementById('ai-count').textContent = `${withAI.length} resposta${withAI.length !== 1 ? 's' : ''}`;
      
      if (withAI.length === 0) {
        container.innerHTML = '';
        noAI.style.display = 'block';
        return;
      }
      
      noAI.style.display = 'none';
      container.innerHTML = withAI.slice(0, 10).map(m => {
        const date = new Date(m.created_at).toLocaleString('pt-BR');
        
        return `
          <div class="message-bubble message-ia bg-purple-50 p-4 rounded-xl">
            <div class="flex justify-between items-start mb-2">
              <span class="font-semibold text-purple-700">${m.phone}</span>
              <span class="text-xs text-purple-400">${date}</span>
            </div>
            <p class="text-slate-600 text-sm mb-2">"${m.text || 'â€”'}"</p>
            <div class="bg-white p-3 rounded-lg border border-purple-100">
              <p class="text-sm text-slate-700">${m.deepseek_response || 'â€”'}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDocuments(docs) {
      const container = document.getElementById('documents-list');
      const noDocs = document.getElementById('no-docs');
      document.getElementById('docs-count').textContent = `${docs.length} documento${docs.length !== 1 ? 's' : ''}`;
      
      if (docs.length === 0) {
        container.innerHTML = '';
        noDocs.style.display = 'block';
        return;
      }
      
      noDocs.style.display = 'none';
      container.innerHTML = docs.slice(0, 10).map(doc => {
        const icone = doc.tipo === 'image' ? 'ğŸ–¼ï¸' : doc.tipo === 'pdf' ? 'ğŸ“„' : 'ğŸ“';
        const size = doc.file_size ? (doc.file_size / 1024).toFixed(1) + ' KB' : 'â€”';
        const date = new Date(doc.created_at).toLocaleString('pt-BR');
        const driveLink = doc.drive_url ? `<a href="${doc.drive_url}" target="_blank" class="text-green-600 hover:text-green-700 font-medium flex items-center gap-1">ğŸ“‚ Ver no Drive</a>` : '<span class="text-slate-400">Salvo localmente</span>';
        
        return `
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors">
            <div class="flex items-center gap-4">
              <span class="text-3xl">${icone}</span>
              <div>
                <p class="font-semibold text-slate-800">${doc.file_name || 'Arquivo sem nome'}</p>
                <p class="text-sm text-slate-500">${doc.phone} â€¢ ${size} â€¢ ${date}</p>
              </div>
            </div>
            ${driveLink}
          </div>
        `;
      }).join('');
    }

    async function loadAll() {
      try {
        const [statsRes, msgsRes, docsRes] = await Promise.all([
          fetch('/stats'),
          fetch('/api/mensagens'),
          fetch('/api/documentos')
        ]);
        
        const stats = await statsRes.json();
        const msgs = await msgsRes.json();
        const docs = await docsRes.json();
        
        // Stats
        document.getElementById('stat-messages').textContent = stats.messages || 0;
        document.getElementById('stat-docs').textContent = stats.docs || 0;
        document.getElementById('stat-budgets').textContent = stats.budgets || 0;
        document.getElementById('stat-revenue').textContent = 'R$ ' + (stats.faturamento || 0).toLocaleString('pt-BR');
        
        // Messages & AI
        renderMessages(msgs.slice(0, 20));
        renderAIResponses(msgs);
        
        // Documents
        renderDocuments(docs);
      } catch (e) {
        console.error('Erro ao carregar dados:', e);
      }
    }

    async function testMessage() {
      await fetch('/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: 'Teste de mensagem' })
      });
      alert('Mensagem de teste enviada! Aguardando resposta da IA...');
      setTimeout(loadAll, 2000);
    }

    async function testBudget() {
      const res = await fetch('/api/orcamento', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: '5511999999999', cliente: 'Teste', servico: 'transferencia' })
      });
      const data = await res.json();
      alert(`OrÃ§amento gerado: R$ ${data.total.toFixed(2)}`);
      setTimeout(loadAll, 1000);
    }

    // Inicializar
    renderPrices();
    loadAll();
    setInterval(loadAll, 30000);
  </script>
</body>
</html>